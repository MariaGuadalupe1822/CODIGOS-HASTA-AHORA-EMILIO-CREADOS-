{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-tachometer-alt"></i> Dashboard</h1>

<div class="row">
    <!-- Estadísticas principales -->
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Libros</h5>
                        <h2>{{ total_libros }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-book fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Clientes</h5>
                        <h2>{{ total_clientes }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Ventas Totales</h5>
                        <h2>{{ total_ventas }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-shopping-cart fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Ventas Mes</h5>
                        <h2>${{ total_ventas_mes|round(2) }}</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sección de navegación rápida -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-rocket"></i> Acciones Rápidas</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('nueva_venta') }}" class="btn btn-success w-100">
                            <i class="fas fa-plus"></i> Nueva Venta
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('agregar_libro') }}" class="btn btn-primary w-100">
                            <i class="fas fa-book"></i> Agregar Libro
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('listar_clientes') }}" class="btn btn-info w-100">
                            <i class="fas fa-users"></i> Ver Clientes
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('reportes_ventas') }}" class="btn btn-warning w-100">
                            <i class="fas fa-chart-bar"></i> Reportes
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stock bajo -->
{% if libros_stock_bajo %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Stock Bajo</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Libro</th>
                                <th>Autor</th>
                                <th>Stock Actual</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for libro in libros_stock_bajo %}
                            <tr>
                                <td>{{ libro.nombre }}</td>
                                <td>{{ libro.autor }}</td>
                                <td><span class="badge bg-danger">{{ libro.stock }}</span></td>
                                <td>
                                    <a href="{{ url_for('editar_libro', id=libro._id) }}" class="btn btn-sm btn-warning">
                                        <i class="fas fa-edit"></i> Reabastecer
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Gráficos -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Ventas de los últimos 7 días</h5>
            </div>
            <div class="card-body">
                <canvas id="ventasChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-star"></i> Top 5 Libros más Vendidos</h5>
            </div>
            <div class="card-body">
                <canvas id="librosChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Ventas recientes -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history"></i> Ventas Recientes</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Tipo</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venta in ventas_recientes %}
                            <tr>
                                <td>{{ venta.fecha_venta.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>{{ venta.cliente_nombre }}</td>
                                <td>${{ venta.total|round(2) }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if venta.tipo == 'presencial' else 'info' }}">
                                        {{ venta.tipo|title }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('ver_venta', id=venta._id) }}" class="btn btn-sm btn-info">
                                        <i class="fas fa-eye"></i> Ver
                                    </a>
                                    <a href="{{ url_for('comprobante_venta', id=venta._id) }}" class="btn btn-sm btn-secondary">
                                        <i class="fas fa-file-pdf"></i> PDF
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Gráfico de ventas de los últimos 7 días
const ventasCtx = document.getElementById('ventasChart').getContext('2d');
const ventasChart = new Chart(ventasCtx, {
    type: 'line',
    data: {
        labels: {{ fechas|safe }},
        datasets: [{
            label: 'Ventas por día',
            data: {{ ventas_por_dia|safe }},
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }, {
            label: 'Ingresos por día ($)',
            data: {{ ingresos_por_dia|safe }},
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Tendencia de Ventas'
            }
        }
    }
});

// Gráfico de libros más vendidos
const librosCtx = document.getElementById('librosChart').getContext('2d');
const librosChart = new Chart(librosCtx, {
    type: 'bar',
    data: {
        labels: {{ nombres_libros|safe }},
        datasets: [{
            label: 'Unidades vendidas',
            data: {{ ventas_libros|safe }},
            backgroundColor: [
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 99, 132, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(153, 102, 255, 0.6)'
            ],
            borderColor: [
                'rgba(54, 162, 235, 1)',
                'rgba(255, 99, 132, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Libros más populares'
            },
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>
{% endblock %}